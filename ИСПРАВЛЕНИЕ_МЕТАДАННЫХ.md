# Исправление проблемы с метаданными токенов - Переход на Token-2022

## Проблема
Созданные токены использовали метаданные NFT (Metaplex Token Metadata Program) вместо правильных метаданных для SPL токенов. Это приводило к неправильному отображению токенов на Solscan и других обозревателях Solana.

**Предыдущая реализация:** Использовала `createAndMint` из `@metaplex-foundation/mpl-token-metadata`, который создает аккаунты метаданных в стиле NFT.

**Проблема:** Программа Metaplex Token Metadata создана в первую очередь для NFT, а не для взаимозаменяемых SPL токенов. Хотя она может работать с взаимозаменяемыми токенами, это не стандартный подход и токены могут отображаться неправильно на некоторых обозревателях.

## Решение

### Полная переработка: Token-2022 с расширением метаданных
**Было:**
```typescript
import { createAndMint, TokenStandard, mplTokenMetadata } from "@metaplex-foundation/mpl-token-metadata";
import { createUmi, ... } from "@metaplex-foundation/umi";

// Использовался Metaplex UMI SDK с метаданными для NFT
const result = await createAndMint(umi, {
    mint,
    authority: payer,
    name: details.name,
    symbol: details.symbol,
    uri: details.uri,
    tokenStandard: TokenStandard.Fungible,
    ...
}).sendAndConfirm(umi);
```

**Стало:**
```typescript
import { TOKEN_2022_PROGRAM_ID, createInitializeMintInstruction, ... } from "@solana/spl-token";
import { createInitializeInstruction, pack, TokenMetadata } from '@solana/spl-token-metadata';

// Используется Token-2022 (Token Extensions) с нативным расширением метаданных
const transaction = new Transaction().add(
    SystemProgram.createAccount({ ... }),
    createInitializeMetadataPointerInstruction(...),
    createInitializeMintInstruction(...),
    createInitializeInstruction({ 
        metadata: mint, // Метаданные хранятся в самом mint аккаунте
        name, symbol, uri 
    })
);
```

**Почему это важно:** 
- Token-2022 — это новая программа SPL Token с нативной поддержкой расширений метаданных
- Метаданные хранятся непосредственно в mint аккаунте (а не в отдельном аккаунте как у NFT)
- Это стандартный способ создания взаимозаменяемых SPL токенов с метаданными
- Правильно отображается на Solscan и всех обозревателях Solana как SPL токен

### 2. Ключевые технические изменения

#### Удалены зависимости
- ❌ `@metaplex-foundation/mpl-token-metadata` (ориентирован на NFT)
- ❌ `@metaplex-foundation/umi` (фреймворк Metaplex)
- ❌ `@metaplex-foundation/umi-bundle-defaults`

#### Добавлены/использованы зависимости
- ✅ `@solana/spl-token` (уже установлен, включает поддержку Token-2022)
- ✅ `@solana/spl-token-metadata` (автоматически включен в spl-token)

### 3. Основные отличия

| Аспект | Metaplex (NFT) | Token-2022 (SPL) |
|--------|----------------|------------------|
| **Программа** | Token Metadata Program | Token Extensions Program (Token-2022) |
| **ID программы** | `metaqbxxUerdq28cj1RbAWkYQm3ybzjb6a8bt518x1s` | `TokenzQdBNbLqP5VEhdkAS6EPFLC1PHnBqCXEpPxuEb` |
| **Место метаданных** | Отдельный PDA аккаунт | Внутри mint аккаунта |
| **Стандарт токена** | TokenStandard.Fungible | Нативный взаимозаменяемый с расширениями |
| **Основное использование** | NFT | Взаимозаменяемые SPL токены |
| **Отображение на Solscan** | Может показываться как NFT | Показывается как правильный SPL токен |
| **Структура аккаунтов** | Mint + Metadata PDA | Mint со встроенными метаданными |
| **Сложность** | Выше (UMI SDK, множество аккаунтов) | Ниже (стандартный SPL Token) |

### 4. Добавлено подробное логирование
- Выводятся все параметры токена перед созданием
- Выводятся ссылки на Solscan и Explorer после успешного создания
- Упрощает проверку правильности создания метаданных
- Показывается прогресс создания токена по шагам

### 5. Улучшен ответ API
Эндпоинт `/api/create-token` теперь возвращает:
```json
{
  "message": "Token and metadata successfully created.",
  "mintAddress": "адрес токена",
  "transactionSignature": "подпись транзакции",
  "explorerLinkCreate": "ссылка на Solana Explorer",
  "solscanTokenLink": "ссылка на токен в Solscan",
  "solscanTxLink": "ссылка на транзакцию в Solscan",
  "ataAddress": "адрес associated token account"
}
```

## Как протестировать

### Предварительные требования
1. Убедитесь, что на сервисном кошельке достаточно SOL (минимум 0.01 SOL в devnet)
2. Проверить баланс: `GET /api/balance`
3. При необходимости пополните кошелёк через https://faucet.solana.com/

### Шаги для тестирования

#### Шаг 1: Загрузите логотип на IPFS
```bash
curl -X POST http://localhost:3000/api/upload-logo \
  -F "file=@путь/к/логотипу.png"
```

#### Шаг 2: Создайте метаданные JSON и загрузите на IPFS
```bash
# Создайте файл metadata.json
{
  "name": "Тестовый Токен",
  "symbol": "TEST",
  "image": "https://gateway.pinata.cloud/ipfs/Qm...",
  "description": "Тестовый токен для проверки метаданных",
  "attributes": []
}

# Загрузите метаданные
curl -X POST http://localhost:3000/api/upload-logo \
  -F "file=@metadata.json"
```

#### Шаг 3: Создайте токен с метаданными
```bash
curl -X POST http://localhost:3000/api/create-token \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Тестовый Токен",
    "symbol": "TEST",
    "uri": "https://gateway.pinata.cloud/ipfs/Qm...",
    "supply": "1000",
    "decimals": "9"
  }'
```

#### Шаг 4: Проверьте метаданные на Solscan
1. Откройте ссылку `solscanTokenLink` из ответа
2. Убедитесь, что отображаются:
   - Название и символ токена
   - Логотип токена
   - Все поля метаданных
   - Правильное количество и десятичные знаки

## Использование сервисного кошелька
Все транзакции используют сервисный кошелёк, настроенный в `.env`:
- Кошелёк загружается из переменной окружения `SERVICE_SECRET_KEY`
- Адрес кошелька выводится в логи при запуске сервера
- Все комиссии за создание токенов оплачиваются с этого кошелька
- Созданные токены отправляются на associated token account этого кошелька

## Ожидаемый результат
✅ Токен должен появиться на Solscan с:
- Правильным названием и символом
- Логотипом токена
- Заполненными полями метаданных
- Правильным количеством и десятичными знаками

## Возможные проблемы

### Ошибка "Insufficient balance"
- Проверьте баланс: `GET /api/balance`
- Пополните кошелёк через: https://faucet.solana.com/
- Адрес сервисного кошелька показывается в логах сервера

### Метаданные не отображаются на Solscan
- Подождите 1-2 минуты для индексации транзакции
- Убедитесь, что URI метаданных публично доступен
- Проверьте, что JSON метаданных валиден
- Убедитесь, что URL изображения в метаданных доступен

## Дополнительная информация
Полная документация на английском языке доступна в файле `TOKEN_METADATA_FIX.md`.

## Техническая информация

### Как работает Token-2022 с метаданными

**Шаг 1:** Создается mint аккаунт с достаточным пространством для метаданных:
```typescript
const mintLen = getMintLen([ExtensionType.MetadataPointer]);
const metadataLen = pack(metadata).length;
```

**Шаг 2:** Инициализируется указатель метаданных (metadata pointer), который указывает на сам mint аккаунт:
```typescript
createInitializeMetadataPointerInstruction(
    mint,
    payer.publicKey,
    mint, // Метаданные в самом mint!
    TOKEN_2022_PROGRAM_ID
)
```

**Шаг 3:** Инициализируется mint с указанием количества десятичных знаков:
```typescript
createInitializeMintInstruction(
    mint,
    decimals,
    payer.publicKey,
    null,
    TOKEN_2022_PROGRAM_ID
)
```

**Шаг 4:** Инициализируются метаданные непосредственно в mint аккаунте:
```typescript
createInitializeInstruction({
    programId: TOKEN_2022_PROGRAM_ID,
    metadata: mint,
    name, symbol, uri
})
```

**Шаг 5:** Создается associated token account и чеканятся токены:
```typescript
const ata = await createAssociatedTokenAccountIdempotent(..., TOKEN_2022_PROGRAM_ID);
await mintTo(..., TOKEN_2022_PROGRAM_ID);
```

### Почему Token-2022?
Token-2022 (Token Extensions Program) создан специально для взаимозаменяемых SPL токенов с расширенными возможностями:
1. Нативная поддержка метаданных (без отдельных аккаунтов)
2. Метаданные хранятся в самом mint аккаунте
3. Более эффективное использование пространства
4. Правильное отображение на всех обозревателях Solana
5. Стандартный подход для SPL токенов с метаданными

Это гарантирует, что токены всегда отображаются как правильные SPL токены (а не NFT) на Solscan и других обозревателях.
