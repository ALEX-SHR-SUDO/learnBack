# Исправление проблемы с метаданными токенов

## Проблема
Созданные токены не отображали метаданные на Solscan (обозревателе Solana).

## Причина
Проблема была вызвана неправильным импортом функций из пакета `@metaplex-foundation/mpl-token-metadata`. Код использовал приведение типов `as any`, что могло приводить к проблемам во время выполнения.

## Решение

### 1. Исправлены импорты
**Было:**
```typescript
import mplTokenMetadataExports from "@metaplex-foundation/mpl-token-metadata";
const createAndMint = (mplTokenMetadataExports as any).createAndMint;
const TokenStandard = (mplTokenMetadataExports as any).TokenStandard;
const mplTokenMetadata = (mplTokenMetadataExports as any).mplTokenMetadata;
```

**Стало:**
```typescript
import { 
    createAndMint,
    TokenStandard,
    mplTokenMetadata
} from "@metaplex-foundation/mpl-token-metadata";
```

### 2. Добавлено подробное логирование
- Выводятся все параметры токена перед созданием
- Выводятся ссылки на Solscan и Explorer после успешного создания
- Упрощает проверку правильности создания метаданных

### 3. Улучшен ответ API
Эндпоинт `/api/create-token` теперь возвращает:
```json
{
  "message": "Token and metadata successfully created.",
  "mintAddress": "адрес токена",
  "transactionSignature": "подпись транзакции",
  "explorerLinkCreate": "ссылка на Solana Explorer",
  "solscanTokenLink": "ссылка на токен в Solscan",
  "solscanTxLink": "ссылка на транзакцию в Solscan",
  "ataAddress": "адрес associated token account"
}
```

## Как протестировать

### Предварительные требования
1. Убедитесь, что на сервисном кошельке достаточно SOL (минимум 0.01 SOL в devnet)
2. Проверить баланс: `GET /api/balance`
3. При необходимости пополните кошелёк через https://faucet.solana.com/

### Шаги для тестирования

#### Шаг 1: Загрузите логотип на IPFS
```bash
curl -X POST http://localhost:3000/api/upload-logo \
  -F "file=@путь/к/логотипу.png"
```

#### Шаг 2: Создайте метаданные JSON и загрузите на IPFS
```bash
# Создайте файл metadata.json
{
  "name": "Тестовый Токен",
  "symbol": "TEST",
  "image": "https://gateway.pinata.cloud/ipfs/Qm...",
  "description": "Тестовый токен для проверки метаданных",
  "attributes": []
}

# Загрузите метаданные
curl -X POST http://localhost:3000/api/upload-logo \
  -F "file=@metadata.json"
```

#### Шаг 3: Создайте токен с метаданными
```bash
curl -X POST http://localhost:3000/api/create-token \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Тестовый Токен",
    "symbol": "TEST",
    "uri": "https://gateway.pinata.cloud/ipfs/Qm...",
    "supply": "1000",
    "decimals": "9"
  }'
```

#### Шаг 4: Проверьте метаданные на Solscan
1. Откройте ссылку `solscanTokenLink` из ответа
2. Убедитесь, что отображаются:
   - Название и символ токена
   - Логотип токена
   - Все поля метаданных
   - Правильное количество и десятичные знаки

## Использование сервисного кошелька
Все транзакции используют сервисный кошелёк, настроенный в `.env`:
- Кошелёк загружается из переменной окружения `SERVICE_SECRET_KEY`
- Адрес кошелька выводится в логи при запуске сервера
- Все комиссии за создание токенов оплачиваются с этого кошелька
- Созданные токены отправляются на associated token account этого кошелька

## Ожидаемый результат
✅ Токен должен появиться на Solscan с:
- Правильным названием и символом
- Логотипом токена
- Заполненными полями метаданных
- Правильным количеством и десятичными знаками

## Возможные проблемы

### Ошибка "Insufficient balance"
- Проверьте баланс: `GET /api/balance`
- Пополните кошелёк через: https://faucet.solana.com/
- Адрес сервисного кошелька показывается в логах сервера

### Метаданные не отображаются на Solscan
- Подождите 1-2 минуты для индексации транзакции
- Убедитесь, что URI метаданных публично доступен
- Проверьте, что JSON метаданных валиден
- Убедитесь, что URL изображения в метаданных доступен

## Дополнительная информация
Полная документация на английском языке доступна в файле `TOKEN_METADATA_FIX.md`.

## Техническая информация
Функция `createAndMint` из Metaplex создаёт токен и метаданные в одной атомарной транзакции:
1. Создаёт mint account для токена
2. Создаёт metadata account (виден на Solscan)
3. Чеканит начальное количество токенов

Это гарантирует, что метаданные всегда создаются вместе с токеном и видны во всех обозревателях Solana, включая Solscan.
