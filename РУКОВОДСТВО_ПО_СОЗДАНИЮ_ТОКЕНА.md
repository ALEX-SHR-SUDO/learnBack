# Исправление отображения метаданных токенов на Solscan

## Выполненные изменения

### Проблема
Метаданные созданных токенов не отображались на Solscan из-за неправильной инициализации Umi SDK.

### Решение
Изменена инициализация Umi SDK в соответствии с официальной документацией Metaplex.

### Что было изменено

**Файл:** `src/metadata-addition.service.ts`

**До:**
```typescript
import { createUmi, ... } from "@metaplex-foundation/umi";
import { defaultPlugins } from "@metaplex-foundation/umi-bundle-defaults";

function initializeUmi(): any {
    const connection = getConnection();
    const umi = createUmi();
    umi.use(defaultPlugins(connection.rpcEndpoint));
    umi.use(mplTokenMetadata());
    return umi;
}
```

**После:**
```typescript
import { ... } from "@metaplex-foundation/umi";
import { createUmi } from "@metaplex-foundation/umi-bundle-defaults";

function initializeUmi(): any {
    const connection = getConnection();
    // Используем createUmi из umi-bundle-defaults с автоматической загрузкой плагинов
    const umi = createUmi(connection.rpcEndpoint);
    umi.use(mplTokenMetadata());
    return umi;
}
```

### Почему это важно

Согласно официальной документации Metaplex (https://developers.metaplex.com/guides/javascript/how-to-create-a-solana-token):

1. `createUmi` из `@metaplex-foundation/umi-bundle-defaults` автоматически включает стандартные плагины
2. Правильно инициализирует RPC соединение
3. Обеспечивает корректную работу с блокчейном Solana

Предыдущая реализация разделяла эти задачи неправильно, что могло привести к:
- Неполному созданию метаданных
- Ошибкам транзакций
- Отсутствию метаданных на Solscan

## Как создать токен с метаданными

### Автоматический способ

Используйте предоставленный скрипт:

```bash
# Запустите сервер
npm run build
npm start

# В другом терминале запустите скрипт создания токена
./create-test-token.sh
```

Или используйте Node.js версию:

```bash
node create-test-token-cli.mjs
```

### Ручной способ

#### Шаг 1: Подготовьте логотип
Создайте или подготовьте изображение (PNG, JPG, SVG) для логотипа токена.

#### Шаг 2: Загрузите логотип на IPFS
```bash
curl -X POST http://localhost:3000/api/upload-logo \
  -F "file=@/путь/к/логотипу.png"
```

Ответ:
```json
{
  "ipfsUrl": "https://gateway.pinata.cloud/ipfs/Qm..."
}
```

#### Шаг 3: Создайте metadata.json
```json
{
  "name": "Мой Токен",
  "symbol": "MT",
  "description": "Описание моего токена",
  "image": "https://gateway.pinata.cloud/ipfs/Qm...",
  "attributes": [
    {
      "trait_type": "Назначение",
      "value": "Тестирование"
    }
  ],
  "properties": {
    "files": [
      {
        "uri": "https://gateway.pinata.cloud/ipfs/Qm...",
        "type": "image/png"
      }
    ],
    "category": "image"
  }
}
```

#### Шаг 4: Загрузите метаданные на IPFS
```bash
curl -X POST http://localhost:3000/api/upload-logo \
  -F "file=@metadata.json"
```

#### Шаг 5: Создайте токен
```bash
curl -X POST http://localhost:3000/api/create-token \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Мой Токен",
    "symbol": "MT",
    "uri": "https://gateway.pinata.cloud/ipfs/Qm...",
    "supply": "1000000",
    "decimals": "9"
  }'
```

Ответ:
```json
{
  "message": "Token and metadata successfully created.",
  "mintAddress": "...",
  "transactionSignature": "...",
  "solscanTokenLink": "https://solscan.io/token/...?cluster=devnet",
  "solscanTxLink": "https://solscan.io/tx/...?cluster=devnet"
}
```

#### Шаг 6: Проверьте на Solscan
Откройте ссылку `solscanTokenLink`. Вы должны увидеть:
- ✅ Название и символ токена
- ✅ Логотип токена
- ✅ Все поля метаданных
- ✅ Количество и decimals

## Информация о сервисном кошельке

Все операции используют сервисный кошелёк:
- **Адрес**: ESnpcCfEzTu27zimt7buatKXU3ogihyqVozfWJKgv2Jx
- **Сеть**: Solana Devnet

### Проверка баланса
```bash
curl http://localhost:3000/api/balance
```

### Пополнение баланса
Если баланс низкий, пополните кошелёк:
```bash
solana airdrop 1 ESnpcCfEzTu27zimt7buatKXU3ogihyqVozfWJKgv2Jx --url devnet
```

Или посетите: https://faucet.solana.com/

## Технические детали

### Почему createAndMint?
Функция `createAndMint` выполняет атомарно:
1. Создание mint account для токена
2. Создание metadata account (делает токен видимым на Solscan!)
3. Чеканку начального количества токенов

Это гарантирует, что метаданные всегда создаются вместе с токеном.

### Token Standard
Используется `TokenStandard.Fungible` - стандарт для SPL токенов с:
- Фиксированными decimals
- Взаимозаменяемыми единицами
- Поддержкой стандартных метаданных

### Metadata URI
URI указывает на JSON файл на IPFS, содержащий:
- Название и символ токена
- Описание
- URL изображения
- Дополнительные свойства и атрибуты

## Устранение проблем

### Метаданные не отображаются сразу
- **Подождите**: Solscan может индексировать 1-2 минуты
- **Проверьте**: URI метаданных должен быть публично доступен
- **Валидируйте**: JSON должен быть валидным

### Транзакция не проходит
- **Баланс**: Убедитесь, что на кошельке минимум 0.01 SOL
- **Сеть**: Проверьте, что Solana devnet работает
- **Поля**: Все обязательные поля должны быть заполнены

### Ошибка "Invalid URI"
- **Доступность**: URI должен быть публично доступен
- **Формат**: Должен быть валидным URL (http:// или https://)
- **Содержимое**: Должен возвращать валидный JSON

## Резюме

Исправление гарантирует:
1. ✅ Umi SDK правильно инициализируется с стандартными плагинами
2. ✅ Метаданные токена создаются атомарно вместе с токеном
3. ✅ Метаданные соответствуют стандартам Metaplex
4. ✅ Токены сразу видны на Solscan со всеми метаданными
5. ✅ Все операции используют сервисный кошелёк

Реализация теперь строго следует официальному руководству Metaplex, обеспечивая надёжное создание токенов с метаданными, которые корректно отображаются на всех обозревателях Solana, включая Solscan.

## Готовые скрипты

### Bash скрипт
```bash
./create-test-token.sh
```

Этот скрипт:
- Проверяет баланс кошелька
- Создаёт логотип токена
- Загружает логотип на IPFS
- Создаёт и загружает метаданные
- Создаёт токен на Solana
- Выводит все ссылки для проверки

### Node.js скрипт
```bash
node create-test-token-cli.mjs
```

Этот скрипт делает то же самое, но написан на Node.js и может использоваться кроссплатформенно.

## Ссылки

- Официальная документация Metaplex: https://developers.metaplex.com/guides/javascript/how-to-create-a-solana-token
- Solscan: https://solscan.io/
- Solana Explorer: https://explorer.solana.com/
- Solana Devnet Faucet: https://faucet.solana.com/
